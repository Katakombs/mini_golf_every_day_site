<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fresh Watch Test - Mini Golf Every Day</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@latest/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50 text-gray-800 p-8">
  <h1 class="text-3xl font-bold mb-8">Fresh Watch Test - Force Reload</h1>
  
  <div class="mb-8">
    <button onclick="reloadPageWithTime()" class="bg-red-600 text-white px-4 py-2 rounded mr-4">Force Reload JS</button>
    <button onclick="testViaConsole()" class="bg-blue-600 text-white px-4 py-2 rounded">Test Console</button>
  </div>

  <!-- Basic elements needed for testing -->
  <div id="loading" class="text-center py-12">
    <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-green-600"></div>
    <p class="mt-4 text-gray-600">Loading videos...</p>
  </div>
  
  <div id="error" class="text-center py-12 hidden">
    <div class="text-red-500 text-4xl mb-4">‚ö†Ô∏è</div>
    <p class="text-gray-600 mb-4">Error loading videos!</p>
    <button onclick="testLoad()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition">
      Try Again
    </button>
  </div>
  
  <div id="videos-container" class="grid md:grid-cols-2 lg:grid-cols-3 gap-8 hidden"></div>
  
  <div id="no-results" class="text-center py-12 hidden">
    <div class="text-gray-400 text-4xl mb-4">üîç</div>
    <p class="text-gray-600 mb-4">No videos found.</p>
  </div>

  <div id="console-output" class="bg-black text-green-400 p-4 rounded mt-8 font-mono text-sm max-h-96 overflow-y-auto">
    Console output will appear here...
  </div>

  <script>
    const timestamp = Date.now();
    
    function log(message) {
      console.log(message);
      const output = document.getElementById('console-output');
      output.innerHTML += `<div>[${new Date().toLocaleTimeString()}] ${message}</div>`;
      output.scrollTop = output.scrollHeight;
    }

    function reloadPageWithTime() {
      window.location.href = window.location.pathname + '?t=' + Date.now();
    }

    async function testLoad() {
      log('Starting manual load test...');
      try {
        const loading = document.getElementById('loading');
        const error = document.getElementById('error');
        const container = document.getElementById('videos-container');
        
        loading.classList.remove('hidden');
        error.classList.add('hidden');
        container.classList.add('hidden');
        
        log('Making API call...');
        const response = await fetch('/api/videos');
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const data = await response.json();
        log(`Got ${data.videos?.length || 0} videos`);
        
        if (data.videos && data.videos.length > 0) {
          const videos = data.videos.slice(0, 6);
          container.innerHTML = videos.map(video => `
            <div class="bg-white rounded-lg shadow-md p-4">
              <h3 class="font-bold mb-2">${video.title || 'Untitled'}</h3>
              <p class="text-sm text-gray-600">Date: ${video.upload_date}</p>
              <a href="${video.url}" target="_blank" class="text-blue-600 hover:underline">Watch</a>
            </div>
          `).join('');
          
          loading.classList.add('hidden');
          container.classList.remove('hidden');
          log('Success: Videos displayed');
        } else {
          throw new Error('No videos in response');
        }
      } catch (err) {
        log(`Error: ${err.message}`);
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('error').classList.remove('hidden');
      }
    }

    function testViaConsole() {
      log('=== Testing via console ===');
      log('Checking if MGED exists: ' + (typeof window.MGED !== 'undefined'));
      if (window.MGED) {
        log('MGED structure: ' + Object.keys(window.MGED));
        if (window.MGED.pages && window.MGED.pages.watch) {
          log('Watch page functions: ' + Object.keys(window.MGED.pages.watch));
        }
      }
      log('Checking global functions:');
      log('- loadVideos: ' + typeof window.loadVideos);
      log('- filterAndSortVideos: ' + typeof window.filterAndSortVideos);
    }

    // Load the main app.js with timestamp
    log('Loading app.js with timestamp: ' + timestamp);
    const script = document.createElement('script');
    script.src = '/js/app.js?t=' + timestamp;
    script.onload = function() {
      log('app.js loaded successfully');
      testViaConsole();
      setTimeout(testLoad, 2000); // Auto-test after 2 seconds
    };
    script.onerror = function() {
      log('ERROR: Failed to load app.js');
    };
    document.head.appendChild(script);
  </script>
</body>
</html>
