<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Watch - Mini Golf Every Day</title>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@500&family=Inter&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@latest/dist/tailwind.min.css" rel="stylesheet">
  <link href="/css/mytailwind.css" rel="stylesheet">
  <link href="/css/styles.css" rel="stylesheet">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <script src="/js/scripts.js" type="text/javascript"></script>
</head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-S4BQW7NTDC"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-S4BQW7NTDC');
</script>
<body class="bg-white text-gray-800">
  <!-- Header -->
  <header class="bg-green-600 text-white p-4 sticky top-0 z-50 shadow-md">
    <div class="container mx-auto flex flex-col md:flex-row md:justify-between items-center gap-2 md:gap-0">
      <div class="flex items-center space-x-2">
        <img src="images/mgedlogoforreal.svg" alt="Mini Golf Logo" class="w-10 h-10">
        <h1 class="text-2xl brand">Mini Golf Every Day</h1>
      </div>
      <nav class="space-x-4">
        <a href="index.html" class="hover:underline">Home</a>
        <a href="watch.html" class="hover:underline font-semibold">Watch</a>
        <a href="about.html" class="hover:underline">About</a>
      </nav>
    </div>
  </header>

  <!-- Hero Section -->
  <section class="bg-yellow-300 py-8 text-center">
    <h2 class="text-4xl font-bold brand text-green-700">Watch Our Daily Putts</h2>
    <p class="text-lg mt-2 text-gray-700">Catch the latest shots from the Mini Golf Every Day TikTok channel</p>
    <div class="mt-4 bg-white bg-opacity-30 rounded-lg p-3 inline-block">
      <span class="text-green-800 font-semibold">
        <span id="total-videos">Loading...</span> videos and counting!
      </span>
    </div>
  </section>

  <!-- Controls Section -->
  <section class="bg-gray-100 py-6 px-4">
    <div class="container mx-auto max-w-6xl">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <!-- Search -->
        <div class="flex-1 max-w-md">
          <div class="relative">
            <input 
              type="text" 
              id="search-input" 
              placeholder="Search videos by title or day..." 
              class="w-full px-4 py-2 pr-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
            >
            <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
              <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
              </svg>
            </div>
          </div>
        </div>
        
        <!-- Sort Options -->
        <div class="flex items-center space-x-4">
          <label class="text-gray-700 font-medium">Sort by:</label>
          <select id="sort-select" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
            <option value="newest">Newest First</option>
            <option value="oldest">Oldest First</option>
            <option value="title">Title A-Z</option>
          </select>
        </div>
        
        <!-- View Toggle -->
        <div class="flex bg-white rounded-lg border border-gray-300 overflow-hidden">
          <button id="grid-view" class="px-4 py-2 bg-green-600 text-white hover:bg-green-700 transition">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
              <path d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM11 13a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path>
            </svg>
          </button>
          <button id="list-view" class="px-4 py-2 text-gray-600 hover:bg-gray-50 transition">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </section>

  <!-- Videos Section -->
  <section class="bg-yellow-100 w-full px-4 py-12">
    <div class="container mx-auto">
      <!-- Loading State -->
      <div id="loading" class="text-center py-12">
        <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-green-600"></div>
        <p class="mt-4 text-gray-600">Loading your daily mini golf adventures...</p>
      </div>
      
      <!-- Error State -->
      <div id="error" class="text-center py-12 hidden">
        <div class="text-red-500 text-4xl mb-4">‚ö†Ô∏è</div>
        <p class="text-gray-600 mb-4">Oops! We couldn't load the videos right now.</p>
        <button onclick="loadVideos()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition">
          Try Again
        </button>
      </div>
      
      <!-- Videos Grid -->
      <div id="videos-container" class="grid md:grid-cols-2 lg:grid-cols-3 gap-8 max-w-none hidden" data-view="grid"></div>
      
      <!-- No Results -->
      <div id="no-results" class="text-center py-12 hidden">
        <div class="text-gray-400 text-4xl mb-4">üîç</div>
        <p class="text-gray-600 mb-4">No videos found matching your search.</p>
        <button onclick="clearSearch()" class="text-green-600 hover:text-green-800 font-semibold">
          Clear Search
        </button>
      </div>
    </div>
  </section>

  <!-- Load More Button -->
  <section class="py-8 text-center" id="load-more-section" style="display: none;">
    <button id="load-more-btn" class="bg-green-600 text-white px-8 py-3 rounded-lg hover:bg-green-700 transition font-semibold">
      Load More Videos
    </button>
  </section>

  <!-- Stats Section -->
  <section class="bg-green-600 text-white py-12 px-4">
    <div class="container mx-auto max-w-4xl text-center">
      <h2 class="text-3xl font-bold brand mb-8">Mini Golf Every Day Stats</h2>
      <div class="grid md:grid-cols-3 gap-8">
        <div class="bg-white bg-opacity-20 rounded-lg p-6">
          <div class="text-3xl font-bold" id="stats-total">-</div>
          <div class="text-lg">Total Videos</div>
        </div>
        <div class="bg-white bg-opacity-20 rounded-lg p-6">
          <div class="text-3xl font-bold" id="stats-days">-</div>
          <div class="text-lg">Days Running</div>
        </div>
        <div class="bg-white bg-opacity-20 rounded-lg p-6">
          <div class="text-3xl font-bold" id="stats-updated">-</div>
          <div class="text-lg">Last Updated</div>
        </div>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="bg-gray-800 text-white py-8 px-4">
    <div class="container mx-auto text-center">
      <div class="flex items-center justify-center space-x-2 mb-4">
        <img src="images/mgedlogoforreal.svg" alt="Mini Golf Logo" class="w-8 h-8">
        <span class="text-lg brand">Mini Golf Every Day</span>
      </div>
      <p class="text-gray-400 mb-4">Making mini golf magical, one putt at a time.</p>
      <div class="flex justify-center space-x-6">
        <a href="https://www.tiktok.com/@minigolfeveryday" target="_blank" class="text-gray-400 hover:text-white transition">TikTok</a>
        <a href="https://www.instagram.com/mini.golf.every.day/" target="_blank" class="text-gray-400 hover:text-white transition">Instagram</a>
        <a href="index.html" class="text-gray-400 hover:text-white transition">Home</a>
        <a href="about.html" class="text-gray-400 hover:text-white transition">About</a>
      </div>
    </div>
  </footer>

  <!-- Toast Notification -->
  <div id="toast" class="fixed bottom-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-full opacity-0 transition-all duration-300 z-50">
    <span id="toast-message">Notification</span>
  </div>

  <!-- JavaScript for dynamic video loading -->
  <script>
    let allVideos = [];
    let displayedVideos = [];
    let currentPage = 1;
    const videosPerPage = 6;
    let currentView = 'grid';
    
    // Load videos from API
    async function loadVideos() {
      try {
        document.getElementById('loading').classList.remove('hidden');
        document.getElementById('error').classList.add('hidden');
        
        const [statusResponse, videosResponse] = await Promise.all([
          fetch('/api/status'),
          fetch('/api/videos')
        ]);
        
        const statusData = await statusResponse.json();
        const videosData = await videosResponse.json();
        
        // Update stats
        updateStats(statusData);
        
        // Store videos
        allVideos = videosData.videos || [];
        displayedVideos = [...allVideos];
        
        // Update total count
        document.getElementById('total-videos').textContent = allVideos.length;
        
        // Display videos
        displayVideos();
        
        document.getElementById('loading').classList.add('hidden');
        
      } catch (error) {
        console.error('Error loading videos:', error);
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('error').classList.remove('hidden');
      }
    }
    
    function updateStats(statusData) {
      document.getElementById('stats-total').textContent = statusData.video_count || '0';
      document.getElementById('stats-days').textContent = statusData.video_count || '0';
      
      if (statusData.last_updated) {
        const date = new Date(statusData.last_updated);
        document.getElementById('stats-updated').textContent = date.toLocaleDateString();
      }
    }
    
    function displayVideos() {
      const container = document.getElementById('videos-container');
      const startIndex = (currentPage - 1) * videosPerPage;
      const endIndex = startIndex + videosPerPage;
      const videosToShow = displayedVideos.slice(0, endIndex);
      
      if (videosToShow.length === 0) {
        container.classList.add('hidden');
        document.getElementById('no-results').classList.remove('hidden');
        return;
      }
      
      container.classList.remove('hidden');
      document.getElementById('no-results').classList.add('hidden');
      
      // Update container classes based on view
      if (currentView === 'grid') {
        container.className = 'grid md:grid-cols-2 lg:grid-cols-3 gap-8 max-w-none';
      } else {
        container.className = 'space-y-6 max-w-4xl mx-auto';
      }
      
      container.innerHTML = videosToShow.map(video => {
        const uploadDate = video.upload_date ? 
          new Date(video.upload_date.slice(0,4), video.upload_date.slice(4,6)-1, video.upload_date.slice(6,8)).toLocaleDateString() : 
          'Unknown';
          
        if (currentView === 'grid') {
          return `
            <div class="bg-white rounded-lg shadow-md p-4 video-item" data-video-id="${video.video_id}">
              <div class="tiktok-container mb-4">
                <blockquote class="tiktok-embed" 
                            cite="${video.url}" 
                            data-video-id="${video.video_id}" 
                            data-autoplay="false" 
                            style="max-width: 100%; min-width: 325px;">
                  <section>
                    <a target="_blank" title="@minigolfeveryday" href="https://www.tiktok.com/@minigolfeveryday">@minigolfeveryday</a>
                    <p>${video.title || 'Mini golf adventure!'}</p>
                    <a target="_blank" href="${video.url}">‚ô¨ original sound - minigolfeveryday</a>
                  </section>
                </blockquote>
              </div>
              <div class="text-sm text-gray-600 mb-2">
                üìÖ ${uploadDate}
              </div>
              <h3 class="text-lg font-semibold text-gray-800 mb-2 line-clamp-2">
                ${video.title || 'Mini Golf Adventure'}
              </h3>
              <a href="${video.url}" target="_blank" 
                 class="text-green-600 hover:text-green-800 font-medium text-sm">
                Watch on TikTok ‚Üí
              </a>
            </div>
          `;
        } else {
          // List view
          return `
            <div class="bg-white rounded-lg shadow-md p-4 video-item flex flex-col md:flex-row gap-4" data-video-id="${video.video_id}">
              <div class="tiktok-container md:w-80 flex-shrink-0">
                <blockquote class="tiktok-embed" 
                            cite="${video.url}" 
                            data-video-id="${video.video_id}" 
                            data-autoplay="false" 
                            style="max-width: 100%; min-width: 280px;">
                  <section>
                    <a target="_blank" title="@minigolfeveryday" href="https://www.tiktok.com/@minigolfeveryday">@minigolfeveryday</a>
                    <p>${video.title || 'Mini golf adventure!'}</p>
                    <a target="_blank" href="${video.url}">‚ô¨ original sound - minigolfeveryday</a>
                  </section>
                </blockquote>
              </div>
              <div class="flex-1 min-w-0">
                <div class="text-sm text-gray-600 mb-2">
                  üìÖ ${uploadDate}
                </div>
                <h3 class="text-xl font-semibold text-gray-800 mb-3">
                  ${video.title || 'Mini Golf Adventure'}
                </h3>
                <p class="text-gray-600 mb-4">
                  Watch the latest mini golf action from day ${video.title ? video.title.match(/Day (\d+)/)?.[1] || '?' : '?'} of the Mini Golf Every Day challenge!
                </p>
                <div class="flex items-center space-x-4">
                  <a href="${video.url}" target="_blank" 
                     class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition font-medium">
                    Watch on TikTok
                  </a>
                  <button onclick="copyToClipboard('${video.url}')" 
                          class="text-green-600 hover:text-green-800 font-medium">
                    Copy Link
                  </button>
                </div>
              </div>
            </div>
          `;
        }
      }).join('');
      
      // Force TikTok embeds to reload after a short delay
      setTimeout(() => {
        loadTikTokEmbeds();
      }, 100);
      
      // Show/hide load more button
      const loadMoreSection = document.getElementById('load-more-section');
      if (endIndex < displayedVideos.length) {
        loadMoreSection.style.display = 'block';
      } else {
        loadMoreSection.style.display = 'none';
      }
    }
    
    function loadTikTokEmbeds() {
      // Check if we're on localhost (embeds don't work on localhost)
      const isLocalhost = window.location.hostname === 'localhost' || 
                         window.location.hostname === '127.0.0.1';
      
      if (isLocalhost) {
        console.log('Running on localhost - TikTok embeds may not work');
        // Add fallback for failed embeds after a delay
        setTimeout(() => {
          const embeds = document.querySelectorAll('.tiktok-embed');
          embeds.forEach(embed => {
            // Check if embed loaded (has iframe)
            if (!embed.querySelector('iframe')) {
              const videoUrl = embed.getAttribute('cite');
              embed.innerHTML = `
                <div class="bg-gradient-to-br from-pink-500 to-purple-600 text-white rounded-lg p-6 text-center" 
                     style="min-height: 400px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                  <div class="text-6xl mb-4">üé¨</div>
                  <h3 class="text-xl font-bold mb-2">Mini Golf Every Day</h3>
                  <p class="text-pink-100 mb-4">TikTok embed (localhost preview)</p>
                  <a href="${videoUrl}" target="_blank" rel="noopener noreferrer"
                     class="inline-block bg-white text-purple-600 px-6 py-3 rounded-lg hover:bg-gray-100 transition font-semibold">
                    üé• Watch on TikTok
                  </a>
                  <p class="text-xs text-pink-200 mt-4">@minigolfeveryday</p>
                </div>
              `;
            }
          });
        }, 3000);
      }
      
      // Remove any existing TikTok script
      const existingScript = document.querySelector('script[src*="tiktok.com/embed.js"]');
      if (existingScript) {
        existingScript.remove();
      }
      
      // Create new script element
      const script = document.createElement('script');
      script.async = true;
      script.src = 'https://www.tiktok.com/embed.js';
      document.body.appendChild(script);
    }
    
    function filterAndSortVideos() {
      const searchTerm = document.getElementById('search-input').value.toLowerCase();
      const sortOption = document.getElementById('sort-select').value;
      
      // Filter videos
      let filtered = allVideos.filter(video => {
        const title = (video.title || '').toLowerCase();
        const dayMatch = title.includes('day') && title.includes(searchTerm);
        const titleMatch = title.includes(searchTerm);
        return titleMatch || dayMatch;
      });
      
      // Sort videos
      filtered.sort((a, b) => {
        switch (sortOption) {
          case 'newest':
            return (b.upload_date || '').localeCompare(a.upload_date || '');
          case 'oldest':
            return (a.upload_date || '').localeCompare(b.upload_date || '');
          case 'title':
            return (a.title || '').localeCompare(b.title || '');
          default:
            return 0;
        }
      });
      
      displayedVideos = filtered;
      currentPage = 1;
      displayVideos();
    }
    
    function clearSearch() {
      document.getElementById('search-input').value = '';
      filterAndSortVideos();
    }
    
    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(function() {
        showToast('Link copied to clipboard!');
      }).catch(function() {
        showToast('Failed to copy link');
      });
    }
    
    function showToast(message) {
      const toast = document.getElementById('toast');
      const toastMessage = document.getElementById('toast-message');
      
      toastMessage.textContent = message;
      toast.classList.remove('translate-y-full', 'opacity-0');
      toast.classList.add('translate-y-0', 'opacity-100');
      
      setTimeout(() => {
        toast.classList.add('translate-y-full', 'opacity-0');
        toast.classList.remove('translate-y-0', 'opacity-100');
      }, 3000);
    }
    
    function loadMore() {
      currentPage++;
      displayVideos();
    }
    
    // Event listeners
    document.addEventListener('DOMContentLoaded', () => {
      loadVideos();
      
      // Search and sort
      document.getElementById('search-input').addEventListener('input', filterAndSortVideos);
      document.getElementById('sort-select').addEventListener('change', filterAndSortVideos);
      
      // Load more
      document.getElementById('load-more-btn').addEventListener('click', loadMore);
      
      // View toggle
      document.getElementById('grid-view').addEventListener('click', function() {
        this.classList.add('bg-green-600', 'text-white');
        this.classList.remove('text-gray-600');
        document.getElementById('list-view').classList.remove('bg-green-600', 'text-white');
        document.getElementById('list-view').classList.add('text-gray-600');
        currentView = 'grid';
        displayVideos(); // Re-render videos in grid view
      });
      
      document.getElementById('list-view').addEventListener('click', function() {
        this.classList.add('bg-green-600', 'text-white');
        this.classList.remove('text-gray-600');
        document.getElementById('grid-view').classList.remove('bg-green-600', 'text-white');
        document.getElementById('grid-view').classList.add('text-gray-600');
        currentView = 'list';
        displayVideos(); // Re-render videos in list view
      });
    });
  </script>
</body>
</html>
