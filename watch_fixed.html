<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Watch - Mini Golf Every Day (Fixed)</title>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@500&family=Inter&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@latest/dist/tailwind.min.css" rel="stylesheet">
  <link href="/css/mytailwind.css" rel="stylesheet">
  <link href="/css/styles.css" rel="stylesheet">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
</head>
<body class="bg-white text-gray-800">
  <!-- Header -->
  <header class="bg-green-600 text-white p-4 sticky top-0 z-50 shadow-md">
    <div class="container mx-auto flex flex-col md:flex-row md:justify-between items-center gap-2 md:gap-0">
      <div class="flex items-center space-x-2">
        <img src="images/mgedlogoforreal.svg" alt="Mini Golf Logo" class="w-10 h-10">
        <h1 class="text-2xl brand">Mini Golf Every Day</h1>
      </div>
      <nav class="space-x-4">
        <a href="index.html" class="hover:underline">Home</a>
        <a href="watch.html" class="hover:underline font-semibold">Watch</a>
        <a href="blog.html" class="hover:underline">Blog</a>
        <a href="about.html" class="hover:underline">About</a>
      </nav>
    </div>
  </header>

  <!-- Hero Section -->
  <section class="bg-yellow-300 py-8 text-center">
    <h2 class="text-4xl font-bold brand text-green-700">Watch Our Daily Putts</h2>
    <p class="text-lg mt-2 text-gray-700">Catch the latest shots from the Mini Golf Every Day TikTok channel</p>
    <div class="mt-4 bg-white bg-opacity-30 rounded-lg p-3 inline-block">
      <span class="text-green-800 font-semibold">
        <span id="total-videos">Loading...</span> videos and counting!
      </span>
    </div>
  </section>

  <!-- Controls -->
  <section class="bg-white py-6 border-b">
    <div class="container mx-auto px-4">
      <div class="flex flex-col md:flex-row md:justify-between items-center gap-4">
        <!-- Search and Sort -->
        <div class="flex flex-col md:flex-row gap-4 items-center">
          <div class="relative">
            <input type="text" id="search-input" placeholder="Search videos..." 
                   class="pl-4 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
          </div>
          <select id="sort-select" class="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
            <option value="newest">Newest First</option>
            <option value="oldest">Oldest First</option>
            <option value="title">By Title</option>
          </select>
        </div>
        
        <!-- View Toggle -->
        <div class="flex border rounded-lg overflow-hidden">
          <button id="grid-view" class="px-4 py-2 bg-green-600 text-white hover:bg-green-700 transition">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
              <path d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM11 13a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/>
            </svg>
          </button>
          <button id="list-view" class="px-4 py-2 text-gray-600 hover:bg-gray-50 transition">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
              <path d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 8a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 12a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 16a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z"/>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </section>

  <!-- Videos Section -->
  <section class="bg-yellow-100 w-full px-4 py-12">
    <div class="container mx-auto">
      <!-- Loading State -->
      <div id="loading" class="text-center py-12">
        <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-green-600"></div>
        <p class="mt-4 text-gray-600">Loading your daily mini golf adventures...</p>
      </div>
      
      <!-- Error State -->
      <div id="error" class="text-center py-12 hidden">
        <div class="text-red-500 text-4xl mb-4">‚ö†Ô∏è</div>
        <p class="text-gray-600 mb-4">Oops! We couldn't load the videos right now.</p>
        <button onclick="forceReload()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition">
          Try Again
        </button>
      </div>
      
      <!-- Videos Grid -->
      <div id="videos-container" class="grid md:grid-cols-2 lg:grid-cols-3 gap-8 max-w-none hidden" data-view="grid"></div>
      
      <!-- No Results -->
      <div id="no-results" class="text-center py-12 hidden">
        <div class="text-gray-400 text-4xl mb-4">üîç</div>
        <p class="text-gray-600 mb-4">No videos found matching your search.</p>
        <button onclick="clearSearchSimple()" class="text-green-600 hover:text-green-800 font-semibold">
          Clear Search
        </button>
      </div>
    </div>
  </section>

  <!-- Load More Button -->
  <section id="load-more-section" class="text-center py-8 hidden">
    <button id="load-more-btn" class="bg-green-600 text-white px-8 py-3 rounded-lg hover:bg-green-700 transition font-semibold">
      Load More Videos
    </button>
  </section>

  <!-- Footer -->
  <footer class="bg-gray-800 text-white py-12">
    <div class="container mx-auto px-4">
      <div class="grid md:grid-cols-4 gap-8">
        <div>
          <div class="flex items-center space-x-2 mb-4">
            <img src="images/mgedlogoforreal.svg" alt="Mini Golf Logo" class="w-8 h-8">
            <h3 class="text-xl brand">Mini Golf Every Day</h3>
          </div>
          <p class="text-gray-400">Follow our daily mini golf adventures and perfect your putting skills!</p>
        </div>
        <div>
          <h4 class="text-lg font-semibold mb-4">Quick Links</h4>
          <ul class="space-y-2">
            <li><a href="index.html" class="text-gray-400 hover:text-white transition">Home</a></li>
            <li><a href="watch.html" class="text-gray-400 hover:text-white transition">Watch Videos</a></li>
            <li><a href="blog.html" class="text-gray-400 hover:text-white transition">Blog</a></li>
            <li><a href="about.html" class="text-gray-400 hover:text-white transition">About</a></li>
          </ul>
        </div>
        <div>
          <h4 class="text-lg font-semibold mb-4">Social Media</h4>
          <ul class="space-y-2">
            <li><a href="https://www.tiktok.com/@minigolfeveryday" target="_blank" class="text-gray-400 hover:text-white transition">TikTok</a></li>
            <li><a href="#" class="text-gray-400 hover:text-white transition">Instagram</a></li>
            <li><a href="#" class="text-gray-400 hover:text-white transition">YouTube</a></li>
          </ul>
        </div>
        <div>
          <h4 class="text-lg font-semibold mb-4">Contact</h4>
          <p class="text-gray-400">Follow us on social media for the latest updates and mini golf tips!</p>
        </div>
      </div>
      <div class="border-t border-gray-700 mt-8 pt-8 text-center text-gray-400">
        <p>&copy; 2025 Mini Golf Every Day. All rights reserved.</p>
      </div>
    </div>
  </footer>

  <script>
    // Simple, robust video loading solution
    let allVideos = [];
    let displayedVideos = [];
    let currentPage = 1;
    const videosPerPage = 6;
    let currentView = 'grid';
    
    function log(message) {
      console.log('[MGED]', message);
    }

    function showLoading() {
      document.getElementById('loading').classList.remove('hidden');
      document.getElementById('error').classList.add('hidden');
      document.getElementById('videos-container').classList.add('hidden');
    }

    function showError() {
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('error').classList.remove('hidden');
      document.getElementById('videos-container').classList.add('hidden');
    }

    function showVideos() {
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('error').classList.add('hidden');
      document.getElementById('videos-container').classList.remove('hidden');
    }

    function formatDate(dateString) {
      if (!dateString || dateString.length !== 8) return 'Unknown';
      try {
        const year = dateString.slice(0, 4);
        const month = dateString.slice(4, 6) - 1;
        const day = dateString.slice(6, 8);
        return new Date(year, month, day).toLocaleDateString();
      } catch (e) {
        return 'Unknown';
      }
    }

    function generateVideoCard(video) {
      const uploadDate = formatDate(video.upload_date);
      const title = video.title || 'Mini Golf Adventure';
      
      return `
        <div class="bg-white rounded-lg shadow-md p-4 video-item" data-video-id="${video.video_id}">
          <div class="bg-gradient-to-br from-pink-500 to-purple-600 text-white rounded-lg p-6 text-center mb-4" 
               style="min-height: 400px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
            <div class="text-6xl mb-4">üèåÔ∏è</div>
            <h3 class="text-xl font-bold mb-2">Mini Golf Every Day</h3>
            <p class="text-pink-100 mb-6">Watch this amazing mini golf shot!</p>
            <a href="${video.url}" target="_blank" rel="noopener noreferrer"
               class="inline-block bg-white text-purple-600 px-6 py-3 rounded-lg hover:bg-gray-100 transition font-semibold">
              üé• Watch on TikTok
            </a>
            <p class="text-xs text-pink-200 mt-4">@minigolfeveryday</p>
          </div>
          <div class="text-sm text-gray-600 mb-2">
            üìÖ ${uploadDate}
          </div>
          <h3 class="text-lg font-semibold text-gray-800 mb-2 line-clamp-2">
            ${title}
          </h3>
          <a href="${video.url}" target="_blank" 
             class="text-green-600 hover:text-green-800 font-medium text-sm">
            Watch on TikTok ‚Üí
          </a>
        </div>
      `;
    }

    function displayVideos() {
      log('Displaying videos...');
      const container = document.getElementById('videos-container');
      if (!container) {
        log('ERROR: No videos container found');
        return;
      }

      const startIndex = (currentPage - 1) * videosPerPage;
      const endIndex = startIndex + videosPerPage;
      const videosToShow = displayedVideos.slice(0, endIndex);
      
      log(`Showing ${videosToShow.length} videos (page ${currentPage})`);

      if (videosToShow.length === 0) {
        document.getElementById('no-results').classList.remove('hidden');
        container.classList.add('hidden');
        return;
      }

      // Update container classes
      if (currentView === 'grid') {
        container.className = 'grid md:grid-cols-2 lg:grid-cols-3 gap-8 max-w-none';
      } else {
        container.className = 'space-y-6 max-w-4xl mx-auto';
      }

      // Generate and insert HTML
      container.innerHTML = videosToShow.map(video => generateVideoCard(video)).join('');
      
      showVideos();
      
      // Update load more button
      const loadMoreSection = document.getElementById('load-more-section');
      if (loadMoreSection) {
        loadMoreSection.style.display = endIndex < displayedVideos.length ? 'block' : 'none';
      }
      
      log('Videos displayed successfully');
    }

    async function loadVideos() {
      log('Loading videos...');
      showLoading();
      
      try {
        const [statusResponse, videosResponse] = await Promise.all([
          fetch('/api/status'),
          fetch('/api/videos')
        ]);

        if (!statusResponse.ok || !videosResponse.ok) {
          throw new Error('API request failed');
        }

        const statusData = await statusResponse.json();
        const videosData = await videosResponse.json();

        log(`Loaded ${videosData.videos?.length || 0} videos`);

        // Update stats
        const totalVideosEl = document.getElementById('total-videos');
        if (totalVideosEl) {
          totalVideosEl.textContent = videosData.total_count || videosData.videos?.length || '180+';
        }

        // Store videos
        allVideos = videosData.videos || [];
        displayedVideos = [...allVideos];
        currentPage = 1;

        if (allVideos.length === 0) {
          throw new Error('No videos found');
        }

        displayVideos();

      } catch (error) {
        log(`Error loading videos: ${error.message}`);
        showError();
      }
    }

    function filterAndSortVideos() {
      const searchInput = document.getElementById('search-input');
      const sortSelect = document.getElementById('sort-select');
      
      if (!searchInput || !sortSelect) return;
      
      const searchTerm = searchInput.value.toLowerCase();
      const sortOption = sortSelect.value;
      
      // Filter
      let filtered = allVideos.filter(video => {
        const title = (video.title || '').toLowerCase();
        return title.includes(searchTerm);
      });
      
      // Sort
      filtered.sort((a, b) => {
        switch (sortOption) {
          case 'newest':
            return (b.upload_date || '').localeCompare(a.upload_date || '');
          case 'oldest':
            return (a.upload_date || '').localeCompare(b.upload_date || '');
          case 'title':
            return (a.title || '').localeCompare(b.title || '');
          default:
            return 0;
        }
      });
      
      displayedVideos = filtered;
      currentPage = 1;
      displayVideos();
    }

    function clearSearchSimple() {
      const searchInput = document.getElementById('search-input');
      if (searchInput) {
        searchInput.value = '';
        filterAndSortVideos();
      }
    }

    function loadMore() {
      currentPage++;
      displayVideos();
    }

    function switchView(newView) {
      currentView = newView;
      
      const gridBtn = document.getElementById('grid-view');
      const listBtn = document.getElementById('list-view');
      
      if (gridBtn && listBtn) {
        if (newView === 'grid') {
          gridBtn.classList.add('bg-green-600', 'text-white');
          gridBtn.classList.remove('text-gray-600');
          listBtn.classList.remove('bg-green-600', 'text-white');
          listBtn.classList.add('text-gray-600');
        } else {
          listBtn.classList.add('bg-green-600', 'text-white');
          listBtn.classList.remove('text-gray-600');
          gridBtn.classList.remove('bg-green-600', 'text-white');
          gridBtn.classList.add('text-gray-600');
        }
      }
      
      displayVideos();
    }

    function forceReload() {
      window.location.reload();
    }

    // Event listeners
    function setupEventListeners() {
      const searchInput = document.getElementById('search-input');
      if (searchInput) {
        let timeout;
        searchInput.addEventListener('input', () => {
          clearTimeout(timeout);
          timeout = setTimeout(filterAndSortVideos, 300);
        });
      }

      const sortSelect = document.getElementById('sort-select');
      if (sortSelect) {
        sortSelect.addEventListener('change', filterAndSortVideos);
      }

      const loadMoreBtn = document.getElementById('load-more-btn');
      if (loadMoreBtn) {
        loadMoreBtn.addEventListener('click', loadMore);
      }

      const gridBtn = document.getElementById('grid-view');
      const listBtn = document.getElementById('list-view');
      
      if (gridBtn) gridBtn.addEventListener('click', () => switchView('grid'));
      if (listBtn) listBtn.addEventListener('click', () => switchView('list'));
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      log('Page loaded, initializing...');
      setupEventListeners();
      loadVideos();
    });
  </script>
</body>
</html>
